# EDR Capa 支援開發檢查清單

## 文件資訊

| 項目 | 內容 |
|------|------|
| 文件版本 | 1.2.0 |
| 建立日期 | 2025-10-29 |
| 最後更新 | 2025-10-29 |
| 用途 | 功能開發檢查清單 |

---

## 使用說明

本檢查清單列出 EDR Capa 支援專案需要實作的所有功能。每個任務都有：
- **任務編號**：用於追蹤和引用
- **任務描述**：清楚說明要實作什麼
- **功能說明**：詳細的功能需求
- **優先級**：P0（關鍵）、P1（重要）、P2（一般）、P3（可選）
- **檢查欄**：完成後打勾 ✅

**進度追蹤格式**：
- [ ] 未開始
- [進行中] 開發中
- [✅] 已完成
- [❌] 已取消
- [⚠️] 有問題需處理

---

## 模組 1：規則解析器

### 1.1 YAML 函式庫整合

- [ ] **PARSER-001** 選擇並整合 YAML 函式庫
  - **功能說明**：
    - 評估並選擇合適的 YAML 解析函式庫（yaml-cpp、RapidYAML、libyaml）
    - 整合函式庫至專案建置系統
    - 確保能正確解析標準 YAML 格式
  - **優先級**：P0

### 1.2 資料結構定義

- [ ] **PARSER-002** 定義 Meta 資料結構
  - **功能說明**：
    - 實作 `Meta` class/struct
    - 包含所有必要欄位：name、namespace、authors、scopes、att&ck、mbc、references、examples、description、lib
    - 實作序列化/反序列化方法
  - **優先級**：P0

- [ ] **PARSER-003** 定義 FeatureNode 基礎介面
  - **功能說明**：
    - 定義 `FeatureNode` 抽象基類
    - 宣告 `evaluate(EvaluationContext& ctx)` 純虛擬方法
    - 定義 `getType()` 和 `toString()` 方法
  - **優先級**：P0

- [ ] **PARSER-004** 定義邏輯節點類別
  - **功能說明**：
    - 實作 `AndNode`：所有子節點為真才匹配
    - 實作 `OrNode`：任一子節點為真即匹配
    - 實作 `NotNode`：子節點為假才匹配
    - 實作 `CountNode`：支援 "N or more"、"N or fewer"、"(min, max)" 語法
    - 實作 `OptionalNode`："0 or more" 的別名
  - **優先級**：P0

- [ ] **PARSER-005** 定義基本陳述節點類別
  - **功能說明**：
    - 實作 `ApiStatement`：API 呼叫匹配
    - 實作 `StringStatement`：字串匹配（含正規表示式）
    - 實作 `SubstringStatement`：子字串匹配
    - 實作 `BytesStatement`：位元組序列匹配
    - 實作 `NumberStatement`：數值常數匹配
  - **優先級**：P0

- [ ] **PARSER-006** 定義進階陳述節點類別
  - **功能說明**：
    - 實作 `OsStatement`：作業系統匹配
    - 實作 `ArchStatement`：CPU 架構匹配
    - 實作 `FormatStatement`：檔案格式匹配
    - 實作 `CharacteristicStatement`：特徵匹配
    - 實作 `ImportStatement`：匯入函數匹配
    - 實作 `ExportStatement`：匯出函數匹配
    - 實作 `SectionStatement`：PE 區段匹配
    - 實作 `MatchStatement`：規則相依匹配
  - **優先級**：P1

### 1.3 解析器實作

- [ ] **PARSER-007** 實作 Meta 區塊解析器
  - **功能說明**：
    - 解析 YAML 中的 `meta` 區塊
    - 驗證必要欄位存在（name、namespace、scopes、examples）
    - 處理可選欄位
    - 提供清晰的錯誤訊息
  - **優先級**：P0

- [ ] **PARSER-008** 實作 Features 區塊遞迴解析器
  - **功能說明**：
    - 遞迴解析 `features` 區塊
    - 建構特徵樹（支援巢狀結構）
    - 正確處理 and/or/not/count 邏輯節點
    - 正確解析所有陳述節點類型
  - **優先級**：P0

- [ ] **PARSER-009** 實作規則驗證器
  - **功能說明**：
    - 驗證規則結構完整性
    - 檢查規則邏輯一致性（例如：空的 and 節點）
    - 偵測不支援的特徵類型並發出警告
    - 驗證規則相依性（檢查循環依賴）
  - **優先級**：P0

- [ ] **PARSER-010** 實作 RuleParser 主類別
  - **功能說明**：
    - 實作 `parse(yamlContent)` 方法：從字串解析
    - 實作 `parseFile(filePath)` 方法：從檔案解析
    - 實作 `parseDirectory(dirPath, filter)` 方法：批次載入規則
    - 完善的錯誤處理機制
  - **優先級**：P0

### 1.4 規則管理

- [ ] **PARSER-011** 實作規則載入管理
  - **功能說明**：
    - 從本地檔案系統載入規則
    - 從遠端伺服器下載規則（HTTP/HTTPS）
    - 支援規則熱更新（無需重啟服務）
    - 按條件過濾規則（命名空間、OS、嚴重性）
  - **優先級**：P1

- [ ] **PARSER-012** 實作規則快取機制
  - **功能說明**：
    - 快取已解析的規則物件
    - 避免重複解析相同規則
    - 實作 LRU 淘汰策略
  - **優先級**：P2

---

## 模組 2：事件抽象層

### 2.1 標準化事件定義

- [ ] **EVENT-001** 定義 ApiCallEvent 結構
  - **功能說明**：
    - 定義 API 呼叫事件結構：pid、tid、timestamp、functionName、arguments、returnValue、moduleName
    - 實作序列化/反序列化方法
    - 統一時間戳格式（UTC 毫秒級）
  - **優先級**：P0

- [ ] **EVENT-002** 定義 ProcessMemoryRegion 結構
  - **功能說明**：
    - 定義程序記憶體區域結構：pid、baseAddress、size、content、protection、isExecutable
    - 支援懶加載（content 可選）
    - 實作記憶體內容存取方法
  - **優先級**：P0

- [ ] **EVENT-003** 定義 SystemInfo 結構
  - **功能說明**：
    - 定義系統資訊結構：os、arch、osVersion、hostname
    - 實作系統資訊收集方法（Windows API）
    - 支援快取機制
  - **優先級**：P0

- [ ] **EVENT-004** 定義 ProcessInfo 結構
  - **功能說明**：
    - 定義程序資訊結構：pid、ppid、imagePath、commandLine、userName、startTime、imageHash
    - 實作程序資訊收集方法
    - 計算程序映像檔雜湊值（SHA256）
  - **優先級**：P0

- [ ] **EVENT-005** 定義其他事件結構
  - **功能說明**：
    - 定義檔案系統事件結構
    - 定義登錄檔事件結構
    - 定義網路事件結構
    - 統一事件基類設計
  - **優先級**：P1

### 2.2 事件正規化器

- [ ] **EVENT-006** 實作 API 呼叫事件正規化器
  - **功能說明**：
    - 將 EDR 原始 API Hook 資料轉換為 `ApiCallEvent`
    - 標準化時間戳為 UTC
    - 標準化函數名稱（處理大小寫、模組名稱）
    - 解析參數和回傳值
  - **優先級**：P0

- [ ] **EVENT-007** 實作程序事件正規化器
  - **功能說明**：
    - 處理程序建立事件
    - 處理程序終止事件
    - 提取完整程序資訊
  - **優先級**：P0

- [ ] **EVENT-008** 實作記憶體事件正規化器
  - **功能說明**：
    - 處理記憶體配置事件
    - 處理記憶體保護變更事件
    - 追蹤記憶體區域狀態
  - **優先級**：P1

- [ ] **EVENT-009** 實作檔案系統事件正規化器
  - **功能說明**：
    - 處理檔案讀取/寫入事件
    - 處理檔案刪除/重新命名事件
    - 標準化檔案路徑
  - **優先級**：P1

- [ ] **EVENT-010** 實作登錄檔事件正規化器
  - **功能說明**：
    - 處理登錄檔鍵值讀取/寫入事件
    - 處理登錄檔刪除事件
    - 標準化登錄檔路徑
  - **優先級**：P2

### 2.3 事件佇列管理

- [ ] **EVENT-011** 實作事件佇列
  - **功能說明**：
    - 實作執行緒安全的事件佇列
    - 支援高併發寫入
    - 實作背壓機制（防止記憶體溢位）
    - 支援事件優先級
  - **優先級**：P0

- [ ] **EVENT-012** 實作事件快取機制
  - **功能說明**：
    - 按程序分組快取事件
    - 實作 LRU 淘汰策略
    - 可配置快取大小和時間視窗
    - 監控快取命中率
  - **優先級**：P1

---

## 模組 3：匹配引擎

### 3.1 評估上下文

- [ ] **MATCH-001** 實作 EvaluationContext 類別
  - **功能說明**：
    - 維護 API 呼叫歷史快取
    - 維護程序記憶體快取
    - 維護系統資訊
    - 維護規則匹配結果快取
    - 維護評估節點快取
  - **優先級**：P0

- [ ] **MATCH-002** 實作 getApiCallHistory 方法
  - **功能說明**：
    - 查詢指定程序的 API 呼叫記錄
    - 支援時間範圍過濾
    - 結果自動快取
  - **優先級**：P0

- [ ] **MATCH-003** 實作 getProcessMemory 方法
  - **功能說明**：
    - 讀取程序記憶體內容（懶加載）
    - 實作記憶體掃描超時機制
    - 快取記憶體內容
    - 僅掃描可讀取的記憶體區域
  - **優先級**：P0

- [ ] **MATCH-004** 實作 getSystemInfo 方法
  - **功能說明**：
    - 收集系統資訊（OS、架構、版本）
    - 快取系統資訊（啟動時收集一次）
    - 支援動態更新
  - **優先級**：P0

- [ ] **MATCH-005** 實作 getRuleResult 方法
  - **功能說明**：
    - 查詢其他規則的匹配結果
    - 支援規則相依性解析
    - 偵測循環依賴並拋出例外
  - **優先級**：P1

### 3.2 邏輯節點評估器

- [ ] **MATCH-006** 實作 AndNode 評估器
  - **功能說明**：
    - 所有子節點都為真才回傳真
    - 實作短路評估（遇到假值立即回傳）
    - 利用快取避免重複評估
  - **優先級**：P0

- [ ] **MATCH-007** 實作 OrNode 評估器
  - **功能說明**：
    - 任一子節點為真即回傳真
    - 實作短路評估（遇到真值立即回傳）
    - 利用快取避免重複評估
  - **優先級**：P0

- [ ] **MATCH-008** 實作 NotNode 評估器
  - **功能說明**：
    - 子節點為假才回傳真
    - 正確處理快取
  - **優先級**：P0

- [ ] **MATCH-009** 實作 CountNode 評估器
  - **功能說明**：
    - 支援 "N or more" 語法（至少 N 個為真）
    - 支援 "N or fewer" 語法（最多 N 個為真）
    - 支援 "(min, max)" 範圍語法
    - 實作短路評估（達到條件立即回傳）
  - **優先級**：P0

### 3.3 基本特徵評估器

- [ ] **MATCH-010** 實作 ApiStatement 評估器
  - **功能說明**：
    - 從上下文取得 API 呼叫歷史
    - 匹配精確 API 名稱
    - 自動匹配 A/W 後綴版本（CreateFile → CreateFileA/CreateFileW）
    - 支援帶/不帶模組名稱的匹配
  - **優先級**：P0

- [ ] **MATCH-011** 實作 StringStatement 評估器
  - **功能說明**：
    - 觸發懶加載記憶體掃描
    - 在程序記憶體中搜尋字串
    - 支援精確匹配
    - 支援正規表示式匹配
    - 支援 case-insensitive 選項
    - 支援 UTF-8 和 UTF-16 編碼
  - **優先級**：P0

- [ ] **MATCH-012** 實作 SubstringStatement 評估器
  - **功能說明**：
    - 觸發懶加載記憶體掃描
    - 子字串匹配（前後自動加萬用字元）
    - 支援 UTF-8 和 UTF-16 編碼
  - **優先級**：P0

- [ ] **MATCH-013** 實作 BytesStatement 評估器
  - **功能說明**：
    - 觸發懶加載記憶體掃描
    - 在記憶體中搜尋位元組序列
    - 支援最多 0x100 位元組
    - 從序列開頭匹配
  - **優先級**：P0

- [ ] **MATCH-014** 實作 NumberStatement 評估器
  - **功能說明**：
    - 在記憶體中搜尋數值的二進位表示
    - 在 API 參數中搜尋數值
    - 支援十六進位和十進位格式
    - 支援不同位元組順序（little-endian/big-endian）
  - **優先級**：P0

- [ ] **MATCH-015** 實作 OsStatement 評估器
  - **功能說明**：
    - 從 SystemInfo 取得作業系統資訊
    - 匹配指定的 OS（windows、linux、macos 等）
    - 結果已快取
  - **優先級**：P0

- [ ] **MATCH-016** 實作 ArchStatement 評估器
  - **功能說明**：
    - 從 SystemInfo 取得 CPU 架構資訊
    - 匹配指定的架構（i386、amd64）
    - 結果已快取
  - **優先級**：P0

- [ ] **MATCH-017** 實作 FormatStatement 評估器
  - **功能說明**：
    - 偵測程序可執行檔格式
    - 支援 PE 格式偵測（檢查 MZ 標頭）
    - 支援 ELF 格式偵測（未來）
    - 支援 .NET 格式偵測（檢查 CLR 標頭）
  - **優先級**：P1

### 3.4 進階特徵評估器

- [ ] **MATCH-018** 實作 CharacteristicStatement 評估器
  - **功能說明**：
    - 將 capa characteristic 映射至 EDR 行為特徵
    - 實作至少以下映射：
      - `packed`：高熵值記憶體區段
      - `embedded pe`：記憶體中的 PE 檔案（搜尋 MZ 標頭）
      - `loop`：重複執行的程式碼模式
      - `nzxor`：非歸零 XOR 操作
    - 建立可擴展的映射機制
  - **優先級**：P1

- [ ] **MATCH-019** 實作 ImportStatement 評估器
  - **功能說明**：
    - 解析程序 PE 檔案的匯入表（IAT）
    - 匹配指定的匯入函數
    - 支援 DLL 名稱匹配
    - 支援序數（ordinal）匯入
    - 快取解析結果
  - **優先級**：P1

- [ ] **MATCH-020** 實作 ExportStatement 評估器
  - **功能說明**：
    - 解析程序 PE 檔案的匯出表（EAT）
    - 匹配指定的匯出函數
    - 支援轉送匯出（forwarded export）
    - 快取解析結果
  - **優先級**：P2

- [ ] **MATCH-021** 實作 SectionStatement 評估器
  - **功能說明**：
    - 解析程序 PE 檔案的區段表
    - 匹配指定的區段名稱（例如：.rsrc、.text）
    - 快取解析結果
  - **優先級**：P2

- [ ] **MATCH-022** 實作 MatchStatement 評估器
  - **功能說明**：
    - 查詢其他規則的匹配結果
    - 支援規則名稱匹配
    - 支援命名空間匹配（匹配命名空間下所有規則）
    - 處理規則相依性（自動解析執行順序）
    - 偵測並拒絕循環依賴
  - **優先級**：P1

### 3.5 快取與最佳化

- [ ] **MATCH-023** 實作評估快取
  - **功能說明**：
    - 快取特徵節點的評估結果
    - 相同節點不重複評估
    - 正確管理快取生命週期（按程序）
  - **優先級**：P1

- [ ] **MATCH-024** 實作記憶體掃描快取
  - **功能說明**：
    - 快取程序記憶體內容
    - 相同程序記憶體不重複讀取
    - 實作快取失效機制（記憶體變更時）
    - 限制快取大小（防止記憶體溢位）
  - **優先級**：P1

- [ ] **MATCH-025** 實作短路評估最佳化
  - **功能說明**：
    - AND 節點遇到假值立即停止評估
    - OR 節點遇到真值立即停止評估
    - COUNT 節點達到條件立即停止評估
  - **優先級**：P1

- [ ] **MATCH-026** 實作懶加載記憶體掃描
  - **功能說明**：
    - 僅在需要時才讀取程序記憶體
    - 避免不必要的記憶體掃描
    - 非同步執行記憶體掃描
    - 設定超時機制
  - **優先級**：P1

- [ ] **MATCH-027** 實作事件預過濾器
  - **功能說明**：
    - 建立規則關心的 API 名稱雜湊表
    - 建立規則關心的字串雜湊表
    - 不符合任何規則的事件快速跳過
    - 減少不必要的規則評估
  - **優先級**：P2

### 3.6 PE 檔案解析器

- [ ] **MATCH-028** 實作 PE 標頭解析器
  - **功能說明**：
    - 解析 DOS 標頭（IMAGE_DOS_HEADER）
    - 解析 NT 標頭（IMAGE_NT_HEADERS）
    - 解析檔案標頭（IMAGE_FILE_HEADER）
    - 解析選用標頭（IMAGE_OPTIONAL_HEADER）
  - **優先級**：P1

- [ ] **MATCH-029** 實作 PE 區段解析器
  - **功能說明**：
    - 解析區段表（IMAGE_SECTION_HEADER）
    - 提取區段名稱、大小、權限
    - 計算區段熵值（用於 packed characteristic）
  - **優先級**：P1

- [ ] **MATCH-030** 實作 PE 匯入表解析器
  - **功能說明**：
    - 解析匯入目錄表（IMAGE_IMPORT_DESCRIPTOR）
    - 提取 DLL 名稱和函數名稱
    - 處理序數匯入
  - **優先級**：P1

- [ ] **MATCH-031** 實作 PE 匯出表解析器
  - **功能說明**：
    - 解析匯出目錄表（IMAGE_EXPORT_DIRECTORY）
    - 提取匯出函數名稱
    - 處理轉送匯出（forwarded export）
  - **優先級**：P2

---

## 模組 4：即時決策與阻擋引擎

### 4.1 威脅等級評估

- [ ] **DECISION-001** 實作威脅等級評估器
  - **功能說明**：
    - 根據規則元資料（ATT&CK、MBC、severity）計算威脅等級
    - 定義威脅等級：Critical（90-100）、High（70-89）、Medium（40-69）、Low（0-39）
    - 考慮行為上下文（程序路徑、簽章、行為序列）
    - 實作威脅分數計算演算法
  - **優先級**：P0

- [ ] **DECISION-002** 實作行為上下文分析器
  - **功能說明**：
    - 分析程序資訊（路徑、簽章、父程序）
    - 追蹤行為序列和時間關聯性
    - 評估行為異常程度
    - 提供上下文加權因子
  - **優先級**：P0

### 4.2 阻擋策略選擇

- [ ] **DECISION-003** 實作阻擋策略決策引擎
  - **功能說明**：
    - 根據威脅等級選擇阻擋策略
    - 支援五種策略：Kill、Block、Suspend、Monitor、Quarantine
    - 實作策略選擇邏輯和決策樹
    - 支援白名單和例外規則檢查
  - **優先級**：P0

- [ ] **DECISION-004** 實作誤報風險評估
  - **功能說明**：
    - 評估可能的誤報風險
    - 檢查已知良性程式
    - 考慮組織特定行為模式
    - 調整阻擋策略以降低誤報
  - **優先級**：P1

- [ ] **DECISION-005** 實作白名單管理
  - **功能說明**：
    - 程序路徑白名單（支援萬用字元）
    - 程式碼簽章白名單
    - 規則例外清單
    - 組織例外管理
    - 白名單快取機制
  - **優先級**：P1

### 4.3 決策配置與管理

- [ ] **DECISION-006** 實作阻擋配置管理
  - **功能說明**：
    - 全域阻擋開關（啟用/停用）
    - 按規則類型配置策略
    - 按程序路徑配置策略
    - 威脅分數閾值設定
    - 支援配置熱更新
  - **優先級**：P0

- [ ] **DECISION-007** 實作阻擋模式切換
  - **功能說明**：
    - 停用模式（僅偵測）
    - 學習模式（記錄但不阻擋）
    - 自動阻擋模式
    - 模式切換 API
  - **優先級**：P1

- [ ] **DECISION-008** 實作決策日誌記錄
  - **功能說明**：
    - 記錄所有決策過程
    - 包含威脅評分、策略選擇理由、白名單檢查結果
    - 支援決策審計和分析
    - 提供決策統計報告
  - **優先級**：P2

---

## 模組 5：響應動作執行器

### 5.1 API 攔截與阻擋

- [ ] **RESPONSE-001** 實作 Kernel Hook 機制
  - **功能說明**：
    - 在核心層攔截系統呼叫
    - 支援 Windows 核心 Hook（SSDT、IRP）
    - 實作 Hook 安裝和移除
    - 確保 Hook 穩定性和安全性
  - **優先級**：P0

- [ ] **RESPONSE-002** 實作 User-mode Hook 機制
  - **功能說明**：
    - 在使用者層攔截 API 呼叫
    - 支援 IAT Hook、Inline Hook
    - 攔截 Win32 API、NTDLL API
    - 實作 Hook 保護機制
  - **優先級**：P0

- [ ] **RESPONSE-003** 實作 API 阻擋邏輯
  - **功能說明**：
    - 同步阻擋（立即回傳錯誤碼）
    - 非同步阻擋（延遲或超時）
    - 欺騙模式（回傳假成功）
    - 支援選擇性 API 攔截
  - **優先級**：P0

- [ ] **RESPONSE-004** 支援關鍵 API 攔截
  - **功能說明**：
    - 程序操作 API（CreateProcess、OpenProcess、TerminateProcess）
    - 檔案操作 API（CreateFile、WriteFile、DeleteFile）
    - 登錄檔操作 API（RegCreateKey、RegSetValue、RegDeleteKey）
    - 網路操作 API（socket、connect、send）
    - 記憶體操作 API（VirtualAllocEx、WriteProcessMemory）
    - 服務操作 API（CreateService、OpenSCManager）
  - **優先級**：P0

### 5.2 程序終止

- [ ] **RESPONSE-005** 實作程序終止功能
  - **功能說明**：
    - 終止目標程序及其所有子程序
    - 清除程序記憶體和資源
    - 支援強制終止（TerminateProcess、NtTerminateProcess、ZwTerminateProcess）
    - 記錄終止操作日誌
  - **優先級**：P0

- [ ] **RESPONSE-006** 實作程序掛起功能
  - **功能說明**：
    - 暫停程序執行
    - 保留程序狀態以供分析
    - 支援恢復執行
    - 實作超時自動處理
  - **優先級**：P1

### 5.3 檔案隔離

- [ ] **RESPONSE-007** 實作檔案隔離功能
  - **功能說明**：
    - 移動惡意檔案至隔離區
    - 使用 AES-256 加密隔離檔案
    - 保留檔案元資料（原始路徑、時間戳、觸發規則）
    - 實作安全隔離區管理
  - **優先級**：P0

- [ ] **RESPONSE-008** 實作檔案還原功能
  - **功能說明**：
    - 從隔離區還原檔案
    - 解密並還原至原始位置
    - 需要管理員授權
    - 記錄還原操作
  - **優先級**：P1

- [ ] **RESPONSE-009** 實作隔離區清理
  - **功能說明**：
    - 定期清理過期隔離檔案
    - 支援手動刪除
    - 隔離區大小限制
    - 隔離檔案統計報告
  - **優先級**：P2

### 5.4 記憶體清除

- [ ] **RESPONSE-010** 實作惡意記憶體清除
  - **功能說明**：
    - 偵測並清除注入的惡意程式碼
    - 釋放惡意分配的記憶體區域
    - 還原被修改的記憶體內容
    - 支援 Shellcode 清除
  - **優先級**：P1

- [ ] **RESPONSE-011** 實作記憶體保護
  - **功能說明**：
    - 保護關鍵系統程序記憶體
    - 防止惡意記憶體寫入
    - 監控記憶體權限變更
    - 實作記憶體完整性檢查
  - **優先級**：P2

### 5.5 系統還原

- [ ] **RESPONSE-012** 實作登錄檔還原
  - **功能說明**：
    - 記錄登錄檔變更快照
    - 還原被惡意修改的登錄檔項目
    - 支援批次還原
    - 實作還原點管理
  - **優先級**：P1

- [ ] **RESPONSE-013** 實作檔案系統還原
  - **功能說明**：
    - 還原被刪除或修改的系統檔案
    - 使用影子複製（VSS）進行還原
    - 記錄檔案變更歷史
    - 支援選擇性還原
  - **優先級**：P2

### 5.6 網路隔離

- [ ] **RESPONSE-014** 實作網路連線阻斷
  - **功能說明**：
    - 阻斷惡意程序的網路連線
    - 支援 IP、Port、Domain 封鎖
    - 實作防火牆規則動態添加
    - 記錄封鎖的連線資訊
  - **優先級**：P1

- [ ] **RESPONSE-015** 實作程序網路隔離
  - **功能說明**：
    - 禁止特定程序的所有網路存取
    - 支援臨時隔離和永久隔離
    - 提供隔離狀態查詢
    - 實作隔離解除功能
  - **優先級**：P2

---

## 模組 6：告警生成與管理

### 6.1 告警生成

- [ ] **ALERT-001** 實作 CapaMatchAlert 類別
  - **功能說明**：
    - 定義告警資料結構
    - 包含：觸發規則元資料、程序資訊、時間戳、觸發路徑、額外上下文
    - 實作 JSON 序列化方法
    - 實作嚴重性計算方法（根據 ATT&CK/MBC）
  - **優先級**：P0

- [ ] **ALERT-002** 實作告警生成器
  - **功能說明**：
    - 規則匹配成功時自動生成告警
    - 填入完整的規則元資料
    - 填入完整的程序資訊
    - 記錄觸發路徑（用於解釋告警原因）
    - 提取 ATT&CK 和 MBC 映射
  - **優先級**：P0

- [ ] **ALERT-003** 實作觸發路徑追蹤
  - **功能說明**：
    - 記錄規則評估過程
    - 記錄匹配的特徵節點
    - 生成可讀的觸發路徑說明
    - 用於告警分析和除錯
  - **優先級**：P1

### 6.2 告警去重

- [ ] **ALERT-004** 實作告警去重機制
  - **功能說明**：
    - 同一程序/規則組合在時間視窗內僅告警一次
    - 可配置去重視窗（預設 5 分鐘）
    - 記錄重複告警的次數
    - 維護去重雜湊表
  - **優先級**：P1

- [ ] **ALERT-005** 實作告警聚合
  - **功能說明**：
    - 相同規則的多個告警可聚合
    - 提供聚合統計資訊
    - 減少告警數量
  - **優先級**：P2

### 6.3 告警傳送

- [ ] **ALERT-006** 實作 HTTP 告警傳送器
  - **功能說明**：
    - 支援 HTTP/HTTPS POST 傳送
    - 使用 TLS 1.3 加密
    - 非同步傳送（不阻塞主流程）
    - 實作連線池管理
  - **優先級**：P0

- [ ] **ALERT-007** 實作告警重試機制
  - **功能說明**：
    - 傳送失敗時自動重試
    - 可配置重試次數（預設 3 次）
    - 實作指數退避策略
    - 超過重試次數後放棄
  - **優先級**：P1

- [ ] **ALERT-008** 實作告警本地快取
  - **功能說明**：
    - 本地快取未成功傳送的告警
    - 使用 SQLite 或檔案儲存
    - 定期重試傳送快取的告警
    - 自動清理過期告警
  - **優先級**：P1

- [ ] **ALERT-009** 實作告警批次傳送
  - **功能說明**：
    - 多個告警可批次傳送
    - 可配置批次大小（預設 10 個）
    - 減少網路請求次數
    - 提升傳送效率
  - **優先級**：P1

---

## 模組 7：效能監控

### 7.1 效能指標收集

- [ ] **PERF-001** 實作 CPU 使用率監控
  - **功能說明**：
    - 監控引擎的 CPU 使用百分比
    - 區分使用者態和核心態時間
    - 定期採樣（預設每 5 分鐘）
  - **優先級**：P1

- [ ] **PERF-002** 實作記憶體使用監控
  - **功能說明**：
    - 監控引擎的記憶體使用量
    - 區分私有記憶體和工作集
    - 偵測記憶體洩漏趨勢
  - **優先級**：P1

- [ ] **PERF-003** 實作延遲監控
  - **功能說明**：
    - 監控事件處理延遲（P50、P95、P99）
    - 監控規則評估延遲
    - 監控告警生成延遲
    - 使用高精度計時器
  - **優先級**：P1

- [ ] **PERF-004** 實作吞吐量監控
  - **功能說明**：
    - 監控每秒處理事件數
    - 監控每秒生成告警數
    - 監控事件佇列深度
  - **優先級**：P1

- [ ] **PERF-005** 實作快取命中率監控
  - **功能說明**：
    - 監控評估快取命中率
    - 監控記憶體快取命中率
    - 監控規則快取命中率
  - **優先級**：P2

### 5.2 效能報告與告警

- [ ] **PERF-006** 實作效能日誌輸出
  - **功能說明**：
    - 定期輸出效能指標至日誌
    - 可配置輸出頻率（預設每小時）
    - 結構化日誌格式（JSON）
  - **優先級**：P1

- [ ] **PERF-007** 實作 Prometheus 匯出器
  - **功能說明**：
    - 實作 Prometheus metrics 端點
    - 匯出所有效能指標
    - 支援 Grafana 視覺化
  - **優先級**：P2

- [ ] **PERF-008** 實作健康檢查端點
  - **功能說明**：
    - 提供 HTTP 健康檢查端點（/health）
    - 回傳服務狀態（運行/停止/異常）
    - 包含版本資訊和基本效能指標
  - **優先級**：P1

- [ ] **PERF-009** 實作效能異常告警
  - **功能說明**：
    - CPU 使用率超過閾值時告警
    - 記憶體使用超過閾值時告警
    - 延遲超過閾值時告警
    - 可配置告警閾值
  - **優先級**：P2

---

## 模組 8：整合與配置

### 8.1 EDR 整合

- [ ] **INTEG-001** 實作 EDR 事件接收器
  - **功能說明**：
    - 從 EDR Agent 接收事件
    - 支援多種事件來源（API Hook、程序監控等）
    - 實作事件佇列
  - **優先級**：P0

- [ ] **INTEG-002** 實作主工作流程
  - **功能說明**：
    - Agent 啟動時載入規則
    - 程序建立時建立 EvaluationContext
    - 事件到達時觸發規則評估
    - 規則匹配時生成告警
  - **優先級**：P0

- [ ] **INTEG-003** 實作規則評估排程器
  - **功能說明**：
    - 管理規則評估順序（考慮相依性）
    - 支援並行評估多條規則
    - 限制併發評估數量（防止資源耗盡）
  - **優先級**：P1

### 8.2 配置管理

- [ ] **CONFIG-001** 實作配置檔案解析器
  - **功能說明**：
    - 支援 JSON 格式配置檔案
    - 解析所有配置項目
    - 驗證配置有效性
    - 提供預設值
  - **優先級**：P0

- [ ] **CONFIG-002** 實作 EngineConfig 類別
  - **功能說明**：
    - 定義所有配置項目：
      - maxConcurrentEvaluations（最大並行評估數）
      - eventQueueSize（事件佇列大小）
      - memoryScanTimeout（記憶體掃描超時）
      - alertDeduplicationWindow（去重視窗）
      - enableMemoryScanning（啟用記憶體掃描）
      - alertEndpoint（告警傳送端點）
      - logLevel（日誌級別）
    - 支援環境變數覆寫
  - **優先級**：P0

- [ ] **CONFIG-003** 實作配置熱更新
  - **功能說明**：
    - 監控配置檔案變更
    - 配置變更時自動重載
    - 無需重啟服務
    - 驗證新配置有效性
  - **優先級**：P2

### 6.3 日誌系統

- [ ] **LOG-001** 實作日誌記錄器
  - **功能說明**：
    - 支援多種日誌級別（DEBUG、INFO、WARNING、ERROR）
    - 結構化日誌格式（JSON）
    - 包含時間戳、執行緒 ID、來源檔案
  - **優先級**：P0

- [ ] **LOG-002** 實作日誌輪轉
  - **功能說明**：
    - 單一日誌檔案最大大小（預設 100MB）
    - 保留最近 N 個檔案（預設 10 個）
    - 壓縮歸檔舊日誌
  - **優先級**：P1

- [ ] **LOG-003** 實作日誌過濾
  - **功能說明**：
    - 根據日誌級別過濾
    - 根據來源模組過濾
    - 避免敏感資料記錄（密碼、金鑰等）
  - **優先級**：P1

---

## 模組 9：匹配引擎 API

### 9.1 主 API 實作

- [ ] **API-001** 實作 MatchingEngine 類別
  - **功能說明**：
    - 引擎初始化和配置
    - 規則載入和管理
    - 事件處理入口
    - 引擎狀態管理
    - 引擎關閉和資源清理
  - **優先級**：P0

- [ ] **API-002** 實作 loadRules 方法
  - **功能說明**：
    - 載入規則集
    - 解析規則相依性
    - 建立規則索引（加速查詢）
    - 驗證規則有效性
  - **優先級**：P0

- [ ] **API-003** 實作 processEvent 方法
  - **功能說明**：
    - 接收單一事件
    - 正規化事件
    - 觸發規則評估
    - 回傳匹配的告警列表
  - **優先級**：P0

- [ ] **API-004** 實作 processBatch 方法
  - **功能說明**：
    - 批次處理多個事件
    - 提升處理效率
    - 回傳所有匹配的告警
  - **優先級**：P1

- [ ] **API-005** 實作 getStats 方法
  - **功能說明**：
    - 回傳引擎統計資訊
    - 包含：處理事件數、生成告警數、快取命中率等
    - 提供效能指標
  - **優先級**：P1

- [ ] **API-006** 實作 updateRules 方法
  - **功能說明**：
    - 熱更新規則（無需重啟）
    - 原子性更新（全部成功或全部失敗）
    - 保留現有評估上下文
  - **優先級**：P1

- [ ] **API-007** 實作 shutdown 方法
  - **功能說明**：
    - 優雅關閉引擎
    - 等待所有進行中的評估完成
    - 清理資源（快取、執行緒等）
    - 保存未傳送的告警
  - **優先級**：P0

---

## 檢查清單統計

### 按模組分佈

| 模組 | 任務數 | P0 | P1 | P2 | P3 |
|------|--------|----|----|----|----|
| 模組 1：規則解析器 | 12 | 9 | 2 | 1 | 0 |
| 模組 2：事件抽象層 | 12 | 7 | 4 | 1 | 0 |
| 模組 3：匹配引擎 | 31 | 15 | 13 | 3 | 0 |
| 模組 4：即時決策與阻擋引擎 | 8 | 4 | 3 | 1 | 0 |
| 模組 5：響應動作執行器 | 15 | 9 | 4 | 2 | 0 |
| 模組 6：告警生成與管理 | 9 | 2 | 6 | 1 | 0 |
| 模組 7：效能監控 | 9 | 0 | 7 | 2 | 0 |
| 模組 8：整合與配置 | 10 | 5 | 3 | 2 | 0 |
| 模組 9：引擎 API | 7 | 4 | 3 | 0 | 0 |
| **總計** | **113** | **55** | **45** | **13** | **0** |

### 優先級分佈

- **P0（關鍵）**：55 個任務（48.7%）- 核心功能，必須實作
- **P1（重要）**：45 個任務（39.8%）- 重要功能，建議實作
- **P2（一般）**：13 個任務（11.5%）- 增強功能，可選實作
- **P3（可選）**：0 個任務（0%）

### 預估工時

- **核心功能（P0）**：約 4-5 個月（2-3 人團隊）
- **完整功能（P0+P1）**：約 7-8 個月（2-3 人團隊）
- **全部功能（P0+P1+P2）**：約 8-9 個月（2-3 人團隊）

---

## 附錄：開發順序建議

### 第一階段：核心基礎（P0 任務）
1. 規則解析器基礎（PARSER-001 到 PARSER-010）
2. 事件抽象層基礎（EVENT-001 到 EVENT-007、EVENT-011）
3. 匹配引擎核心（MATCH-001 到 MATCH-017）
4. 即時決策引擎（DECISION-001、DECISION-002、DECISION-003、DECISION-006）
5. 響應動作執行器（RESPONSE-001 到 RESPONSE-005、RESPONSE-007）
6. 告警生成基礎（ALERT-001、ALERT-002）
7. 整合與 API（INTEG-001、INTEG-002、CONFIG-001、CONFIG-002、LOG-001）
8. 引擎 API（API-001 到 API-003、API-007）

### 第二階段：進階功能（P1 任務）
1. 規則管理（PARSER-011）
2. 事件快取與額外事件類型（EVENT-008 到 EVENT-010、EVENT-012）
3. 進階特徵評估（MATCH-018 到 MATCH-022）
4. 快取與最佳化（MATCH-023 到 MATCH-026）
5. PE 解析器（MATCH-028 到 MATCH-031）
6. 決策引擎進階功能（DECISION-004、DECISION-005、DECISION-007）
7. 響應動作執行器進階功能（RESPONSE-006、RESPONSE-008、RESPONSE-010、RESPONSE-014）
8. 告警去重與傳送（ALERT-004、ALERT-006 到 ALERT-009）
9. 效能監控（PERF-001 到 PERF-006、PERF-008）
10. 配置與日誌（INTEG-003、LOG-002、LOG-003）
11. 引擎 API 增強（API-004 到 API-006）

### 第三階段：優化與增強（P2 任務）
1. 規則快取（PARSER-012）
2. 額外事件正規化（EVENT-010）
3. 事件預過濾器（MATCH-027）
4. 進階 PE 解析（MATCH-031）
5. 決策引擎優化（DECISION-008）
6. 響應動作執行器優化（RESPONSE-009、RESPONSE-011、RESPONSE-013、RESPONSE-015）
7. 告警聚合（ALERT-005）
8. Prometheus 整合（PERF-007、PERF-009）
9. 配置熱更新（CONFIG-003）

---

**文件結束**

*版本歷史*：
- v1.2.0 (2025-10-29): 新增即時決策與阻擋引擎、響應動作執行器模組，支援即時威脅阻擋功能
- v1.1.0 (2025-10-29): 簡化版本，移除測試內容，聚焦功能實作
- v1.0.0 (2025-10-29): 初始版本